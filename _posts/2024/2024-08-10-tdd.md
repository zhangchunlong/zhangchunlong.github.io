---
layout: post
title: TDD学习
categories:
- 技术
tags:
- 软件工程
---

测试驱动开发，英文全称Test-Driven Development，简称TDD，是一种不同于传统软件开发流程的新型的开发方法。它要求在编写某个功能的代码之前先编写测试代码，然后只编写使测试通过的功能代码，通过测试来推动整个开发的进行。

Kent Beck在Test-Driven Development by Example 开头中给出了 TDD 的基本原则:  
当且仅当存在失败的自动化测试时，才开始编写生产代码  
消除重复  
同时将TDD的开发工作分成了三步-红/绿/重构   
红：编写一个失败的小测试，甚至可以是无法编译的测试  
绿：让这个测试快速通过，甚至不惜犯下任何罪恶  
重构：消除上一步中产生的所有重复（坏味道）

在AI如此盛行的2024年，为什么现在还要学习20年的老技术？当前AI还会产生幻觉，生成的代码具有不确定性，个人认为可以通过自动化的测试保证生成代码的功能是保证AI生成代码功能的一个方法，为此专门在极客时间上学习了徐昊老师的"TDD项目实战"。

徐昊老师在2006年总结任务分解法，并将任务分解法作为TDD的核心要素。  
![tdd_task_decomposition](/media/pic/tdd_task_decomposition.png 'tdd_task_decomposition')  
1. 需求分解为功能点，也就是将需求转化为一系列可验证的里程碑点；  
2. 如果已经存在架构或架构愿景，则依据架构中定义的组件与交互，将功能点分解为不同的功能上下文； 如果尚不存在架构愿景，则可以将功能点作为功能上下文；  
3. 将功能点按照功能上下文，分解为任务项。也就是进一步将可验证的里程碑点，分解为功能上下文中可验证的任务项；  
4. 将任务项转化为自动化测试，进入红 / 绿 / 重构循环，驱动功能上下文内的功能实现；  
5. 如果重构涉及功能上下文的重新划分，即提取 / 合并组件，即视作对于架构的重构与梳理。需调整后续功能点中对于功能上下文以及任务项的划分。  
6. 如此往复，直到所有功能完成

举个例子：用户登录功能，这就是一个功能点， 登录涉及Console，后端认证模块， Console和后端认证模块就是功能上下文，在其中分配任务项。

**TDD中测试**  
测试基本结构包括初始化（SetUp）、执行测试（Exercise）、验证结果（Verify）和复原（Teardown）
初始化：主要是设置测试上下文，从而使待测系统（System Under Test）处于可测试的状态。例如，对于需要操作数据库的后台系统，测试上下文包含了已经灌注测试数据的测试用数据库，并将其与待测系统连接。  
执行测试：就是按照测试脚本的描述与待测系统互动。例如，按照功能描述，通过 API 对系统进行相应的操作。  
验证结果：就是验证待测系统是否处于我们期待的状态中。例如，经过测试，数据库中的业务数据是否发生了期待中的改变。  
复原：就是将测试上下文、待测系统复原回测试之前的状态，或者消除测试对于待测系统的副作用。例如，删除测试数据中的数据（通常是通过事务回滚）。  

验证结果是其中最核心步骤，有两种方式状态验证和行为验证  
状态验证是指在与待测系统交互后，通过比对测试上下文与待测系统的状态变化，判断待测系统是否满足需求的验证方式  
行为验证是指通过待测系统与依赖组件的交互，来判断待测系统是否满足需求的验证方式，行为验证背后的逻辑是，状态的改变是由交互引起的。如果所有的交互都正确，那么就可以推断最终的状态也不会错。

另外，徐昊老师将TDD中的测试称为单元级别功能测试与测试领域中的"单元测试"进行区分，强调如下四点：  
TDD 中的测试是由不同粒度的功能测试构成的；  
每一个测试都兼具功能验证和错误定位的功效；  
要从发现问题和定位问题的角度，去思考测试的效用与成本；  
单元粒度要以独立的功能上下文或变化点为粒度。  

**TDD中驱动**

TDD中的测试无法驱动小于其测试单元的功能需求，也无法驱动单元内的实现方式，需要进一步拆分功能上下文才可以；比如无法通过TDD驱动冒泡排序的实现。

**TDD中的流派**  
经典学派强调功能优先，设计 / 架构后置，通过重构进行演进式设计。  
而“伦敦学派”并不排斥预先存在的设计，更强调如何通过测试替身，将注意力集中到功能上下文中的某个对象上。然后在测试的驱动下，按部就班地完成功能开发。  

要是想详细学习可以在极客时间搜 "徐昊 · TDD项目实战70讲"  
https://time.geekbang.org/column/intro/100109401

实践代码：  
https://github.com/zhangchunlong/tdd